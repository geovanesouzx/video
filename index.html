<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clone do WhatsApp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body, html { height: 100%; margin: 0; font-family: sans-serif; }
        .hidden { display: none; }
        /* Animações para transição de tela */
        @keyframes slide-in {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        @keyframes slide-out {
            from { transform: translateX(0); }
            to { transform: translateX(-100%); }
        }
        .slide-in { animation: slide-in 0.3s forwards; }
        .slide-out { animation: slide-out 0.3s forwards; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900">

    <!-- Tela de Carregamento -->
    <div id="loading-screen" class="flex h-screen w-full items-center justify-center">
        <div class="flex items-center space-x-2 text-gray-500">
            <i data-lucide="loader" class="animate-spin"></i><span>Carregando...</span>
        </div>
    </div>

    <!-- Tela de Login -->
    <div id="login-screen" class="hidden h-screen w-full items-center justify-center bg-gray-100 dark:bg-gray-900">
        <div class="w-full max-w-sm p-8 bg-white dark:bg-gray-800 rounded-lg shadow-xl">
            <h1 class="text-2xl font-bold text-center text-gray-800 dark:text-gray-200 mb-2">Bem-vindo!</h1>
            <p class="text-center text-gray-500 dark:text-gray-400 mb-6">Crie seu nome de usuário para começar.</p>
            <form id="login-form">
                <input id="username-input" type="text" placeholder="Digite seu nome de usuário" class="w-full bg-gray-100 dark:bg-gray-700 rounded-md py-3 px-4 focus:outline-none text-gray-800 dark:text-gray-200 mb-4"/>
                <p id="login-error" class="text-red-500 text-sm mb-4 hidden"></p>
                <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white rounded-md py-3 font-semibold transition-colors">Entrar no Chat</button>
            </form>
        </div>
    </div>

    <!-- Aplicativo Principal -->
    <div id="main-app" class="hidden h-screen w-screen flex-col font-sans bg-gray-200 dark:bg-gray-900 text-sm">
        <!-- Cabeçalho Principal -->
        <header class="bg-white dark:bg-gray-800 shadow-md z-20 flex-shrink-0">
            <div class="flex justify-between items-center p-3">
                <h1 class="text-xl font-bold text-green-500">Chat App</h1>
                <div class="text-xs text-gray-500 dark:text-gray-400">
                    Logado como: <span id="current-username" class="font-semibold"></span>
                </div>
            </div>
            <nav id="tab-navigation" class="flex">
                <!-- Botões das Abas -->
            </nav>
        </header>

        <!-- Conteúdo Principal -->
        <main class="flex-1 overflow-hidden relative">
            <!-- Aba de Conversas -->
            <div id="view-chats" class="w-full h-full flex flex-col">
                <header class="p-3 border-b border-gray-200 dark:border-gray-700 flex-shrink-0 flex justify-between items-center">
                    <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-200">Conversas</h2>
                    <button id="add-contact-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                        <i data-lucide="plus-circle"></i>
                    </button>
                </header>
                <div id="contacts-list" class="flex-1 overflow-y-auto"></div>
            </div>

            <!-- Aba de Adicionar Contato -->
            <div id="view-add-contact" class="hidden absolute top-0 left-0 w-full h-full bg-white dark:bg-gray-800 z-30 flex-col">
                 <header class="p-3 border-b border-gray-200 dark:border-gray-700 flex-shrink-0 flex items-center">
                    <button id="back-to-chats-btn" class="p-2 mr-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                        <i data-lucide="arrow-left"></i>
                    </button>
                    <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-200">Adicionar Contato</h2>
                </header>
                <div class="p-3">
                    <input id="search-all-users-input" type="text" placeholder="Pesquisar por nome de usuário..." class="w-full bg-gray-100 dark:bg-gray-700 rounded-full py-2 px-4 focus:outline-none text-gray-800 dark:text-gray-200"/>
                </div>
                <div id="search-results-list" class="flex-1 overflow-y-auto"></div>
            </div>
            
            <!-- Janela de Chat -->
            <div id="view-chat-window" class="hidden absolute top-0 left-0 w-full h-full bg-gray-100 dark:bg-gray-900 z-40 flex-col">
                <!-- O conteúdo do chat será renderizado aqui -->
            </div>
        </main>
    </div>

    <script type="module">
        // #############################################################################
        // ### INSTRUÇÕES IMPORTANTES PARA CORRIGIR O ERRO DE PERMISSÃO ###
        // #############################################################################
        // O erro "FirebaseError: Missing or insufficient permissions" acontece porque
        // a sua base de dados Firestore não permite que a aplicação leia ou escreva dados.
        //
        // PARA CORRIGIR:
        // 1. Vá para o seu painel do Firebase: https://console.firebase.google.com/
        // 2. Selecione o seu projeto (`videochamada11`).
        // 3. No menu à esquerda, vá para Build > Firestore Database.
        // 4. Clique na aba "Regras" (Rules).
        // 5. APAGUE todo o texto que está lá e COPIE E COLE o seguinte código:
        //
        // rules_version = '2';
        // service cloud.firestore {
        //   match /databases/{database}/documents {
        //     // Esta regra permite que qualquer utilizador autenticado leia e escreva
        //     // em qualquer parte da base de dados do seu projeto.
        //     // É ideal para desenvolvimento e testes.
        //     match /{document=**} {
        //       allow read, write: if request.auth != null;
        //     }
        //   }
        // }
        //
        // 6. Clique em "Publicar".
        // 7. Recarregue a sua página. O erro deverá desaparecer.
        // #############################################################################

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, setDoc, getDoc, getDocs, onSnapshot, serverTimestamp, query, where, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined'
            ? JSON.parse(__firebase_config)
            : {
                apiKey: "AIzaSyB98-bStjweF82UALPiw2YiwKKn1IhZASE",
                authDomain: "videochamada11.firebaseapp.com",
                projectId: "videochamada11",
                storageBucket: "videochamada11.appspot.com",
                messagingSenderId: "872635256324",
                appId: "1:872635256324:web:12a6051efe8796730f2f51"
            };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-whatsapp-clone-html';
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let myContacts = [];
        let currentChatPartner = null;
        let unsubscribeContacts = () => {};
        let unsubscribeMessages = () => {};

        const $ = (selector) => document.querySelector(selector);

        // --- Lógica de Navegação e UI ---
        
        function showView(viewId) {
            ['view-chats', 'view-add-contact', 'view-chat-window'].forEach(id => $(`#${id}`).classList.add('hidden'));
            const view = $(`#${viewId}`);
            if (view) {
                view.classList.remove('hidden');
                view.classList.add('slide-in');
            }
        }

        function goBack(fromViewId, toViewId) {
            const fromView = $(`#${fromViewId}`);
            if(fromView) {
                fromView.classList.add('slide-out');
                setTimeout(() => {
                    fromView.classList.add('hidden');
                    fromView.classList.remove('slide-out');
                    showView(toViewId);
                }, 300);
            } else {
                showView(toViewId);
            }
        }

        // --- Funções de Renderização ---

        const renderContactsList = () => {
            const listDiv = $('#contacts-list');
            if (myContacts.length > 0) {
                listDiv.innerHTML = myContacts.map(contact => `
                    <div data-contact-id="${contact.id}" data-contact-username="${contact.username}" class="contact-item flex items-center p-3 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700">
                        <div class="w-12 h-12 bg-gray-300 dark:bg-gray-600 rounded-full flex items-center justify-center mr-3"><i data-lucide="user"></i></div>
                        <h3 class="font-semibold text-gray-800 dark:text-gray-200">${contact.username}</h3>
                    </div>`).join('');
            } else {
                listDiv.innerHTML = `<p class="p-4 text-center text-gray-500">Nenhum contato adicionado. Clique em '+' para encontrar usuários.</p>`;
            }
            lucide.createIcons();
            document.querySelectorAll('.contact-item').forEach(item => item.addEventListener('click', handleSelectChat));
        };

        const renderSearchResults = (results) => {
            const listDiv = $('#search-results-list');
            listDiv.innerHTML = results.map(user => {
                const isContact = myContacts.some(c => c.id === user.id);
                return `
                <div class="flex items-center p-3 justify-between">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-gray-300 dark:bg-gray-600 rounded-full flex items-center justify-center mr-3"><i data-lucide="user"></i></div>
                        <span class="font-semibold text-gray-800 dark:text-gray-200">${user.username}</span>
                    </div>
                    <button data-user-id="${user.id}" data-user-username="${user.username}" class="add-btn px-3 py-1 text-sm rounded-full ${isContact ? 'bg-gray-400 cursor-not-allowed' : 'bg-green-500 hover:bg-green-600 text-white'}" ${isContact ? 'disabled' : ''}>
                        ${isContact ? 'Adicionado' : 'Adicionar'}
                    </button>
                </div>`;
            }).join('');
            lucide.createIcons();
            document.querySelectorAll('.add-btn:not([disabled])').forEach(btn => btn.addEventListener('click', handleAddContact));
        };

        const renderChatWindow = () => {
            $('#view-chat-window').innerHTML = `
                <header class="bg-white dark:bg-gray-800 p-3 shadow-sm flex items-center z-10 flex-shrink-0">
                    <button id="back-to-chats-from-chat" class="p-2 mr-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><i data-lucide="arrow-left"></i></button>
                    <div class="w-10 h-10 bg-gray-300 dark:bg-gray-600 rounded-full flex items-center justify-center mr-3"><i data-lucide="user"></i></div>
                    <h2 class="font-semibold text-gray-800 dark:text-gray-200">${currentChatPartner.username}</h2>
                </header>
                <main id="messages-container" class="flex-1 overflow-y-auto p-4"></main>
                <footer class="bg-white dark:bg-gray-800 p-3 flex-shrink-0">
                    <form id="message-form" class="flex items-center">
                        <input id="message-input" type="text" placeholder="Digite uma mensagem..." class="flex-1 bg-gray-100 dark:bg-gray-700 rounded-full py-2 px-4 focus:outline-none text-gray-800 dark:text-gray-200"/>
                        <button type="submit" class="bg-green-500 hover:bg-green-600 text-white rounded-full p-3 ml-3"><i data-lucide="send"></i></button>
                    </form>
                </footer>`;
            lucide.createIcons();
            $('#back-to-chats-from-chat').addEventListener('click', () => goBack('view-chat-window', 'view-chats'));
            $('#message-form').addEventListener('submit', handleSendMessage);
            listenForMessages();
        };

        const renderMessages = (messages) => {
            const container = $('#messages-container');
            if(!container) return;
            const sorted = messages.sort((a,b) => (a.timestamp?.toMillis() || 0) - (b.timestamp?.toMillis() || 0));
            container.innerHTML = sorted.map(msg => {
                const isSender = msg.senderId === currentUser.uid;
                return `<div class="flex ${isSender ? 'justify-end' : 'justify-start'} mb-2">
                    <div class="rounded-lg px-3 py-2 max-w-xs shadow ${isSender ? 'bg-green-100 dark:bg-green-800' : 'bg-white dark:bg-gray-700'}">
                        <p class="text-sm text-gray-800 dark:text-gray-200">${msg.text}</p>
                    </div>
                </div>`;
            }).join('');
            container.scrollTop = container.scrollHeight;
        };

        // --- Lógica de Dados (Firebase) ---

        const handleSelectChat = (e) => {
            const contactItem = e.currentTarget;
            currentChatPartner = {
                id: contactItem.dataset.contactId,
                username: contactItem.dataset.contactUsername
            };
            renderChatWindow();
            showView('view-chat-window');
        };

        const handleSearchUsers = async () => {
            const searchTerm = $('#search-all-users-input').value.toLowerCase();
            if (searchTerm.length < 3) {
                $('#search-results-list').innerHTML = '';
                return;
            }
            const usersRef = collection(db, `artifacts/${appId}/public/data/users`);
            const q = query(usersRef, where('username', '>=', searchTerm), where('username', '<=', searchTerm + '\uf8ff'));
            
            try {
                const querySnapshot = await getDocs(q);
                const results = querySnapshot.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .filter(user => user.id !== currentUser.uid); // Excluir a si mesmo
                renderSearchResults(results);
            } catch (error) {
                console.error("Erro ao pesquisar usuários:", error);
            }
        };

        const handleAddContact = async (e) => {
            const btn = e.currentTarget;
            const contactId = btn.dataset.userId;
            const contactUsername = btn.dataset.userUsername;
            
            btn.disabled = true;
            btn.textContent = 'Adicionando...';

            const batch = writeBatch(db);
            // Adiciona o novo contato à minha lista
            const myContactRef = doc(db, `artifacts/${appId}/public/data/users/${currentUser.uid}/contacts`, contactId);
            batch.set(myContactRef, { username: contactUsername, id: contactId });
            // Adiciona-me à lista do novo contato
            const theirContactRef = doc(db, `artifacts/${appId}/public/data/users/${contactId}/contacts`, currentUser.uid);
            batch.set(theirContactRef, { username: currentUser.username, id: currentUser.uid });

            try {
                await batch.commit();
                btn.textContent = 'Adicionado';
            } catch (error) {
                console.error("Erro ao adicionar contato:", error);
                btn.textContent = 'Erro!';
            }
        };

        const handleSendMessage = async (e) => {
            e.preventDefault();
            const input = $('#message-input');
            const text = input.value.trim();
            if (!text || !currentChatPartner) return;

            const chatId = [currentUser.uid, currentChatPartner.id].sort().join('_');
            const messagesRef = collection(db, `artifacts/${appId}/public/data/chats/${chatId}/messages`);
            await addDoc(messagesRef, { text, senderId: currentUser.uid, timestamp: serverTimestamp() });
            input.value = '';
        };

        function listenForContacts() {
            unsubscribeContacts();
            const contactsRef = collection(db, `artifacts/${appId}/public/data/users/${currentUser.uid}/contacts`);
            unsubscribeContacts = onSnapshot(contactsRef, (snapshot) => {
                myContacts = snapshot.docs.map(doc => doc.data());
                renderContactsList();
            });
        }

        function listenForMessages() {
            unsubscribeMessages();
            const chatId = [currentUser.uid, currentChatPartner.id].sort().join('_');
            const messagesRef = collection(db, `artifacts/${appId}/public/data/chats/${chatId}/messages`);
            unsubscribeMessages = onSnapshot(messagesRef, (snapshot) => {
                const messages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderMessages(messages);
            });
        }

        // --- Inicialização ---

        const initApp = (user) => {
            currentUser = user;
            $('#current-username').textContent = user.username;
            $('#loading-screen').classList.add('hidden');
            $('#main-app').classList.remove('hidden');
            showView('view-chats');
            listenForContacts();
        };

        const showLogin = () => {
            $('#loading-screen').classList.add('hidden');
            $('#login-screen').classList.remove('hidden');
            $('#login-screen').classList.add('flex');
        };

        window.onload = () => {
            lucide.createIcons();

            // Event Listeners
            $('#login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = $('#username-input').value.trim();
                if(username.length < 3) {
                    $('#login-error').textContent = 'Nome de usuário muito curto.';
                    $('#login-error').classList.remove('hidden');
                    return;
                }
                $('#login-error').classList.add('hidden');
                // Quando o utilizador cria o perfil, guardamos o nome de utilizador no seu documento principal
                await setDoc(doc(db, `artifacts/${appId}/public/data/users`, currentUser.uid), { id: currentUser.uid, username: username }, { merge: true });
                initApp({ uid: currentUser.uid, username });
            });

            $('#add-contact-btn').addEventListener('click', () => showView('view-add-contact'));
            $('#back-to-chats-btn').addEventListener('click', () => goBack('view-add-contact', 'view-chats'));
            $('#search-all-users-input').addEventListener('input', handleSearchUsers);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    const userRef = doc(db, `artifacts/${appId}/public/data/users`, user.uid);
                    const userSnap = await getDoc(userRef);
                    currentUser = { uid: user.uid }; // Define o UID básico
                    if (userSnap.exists() && userSnap.data().username) {
                        initApp({ uid: user.uid, ...userSnap.data() });
                    } else {
                        showLogin();
                    }
                } else {
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("Falha no login anônimo:", error);
                        $('#loading-screen').innerHTML = '<span>Falha na autenticação. Verifique as configurações do Firebase e recarregue.</span>';
                    }
                }
            });
        };
    </script>
</body>
</html>
