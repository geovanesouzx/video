import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { 
    getAuth, 
    onAuthStateChanged, 
    signInAnonymously,
    signInWithCustomToken
} from 'firebase/auth';
import { 
    getFirestore, 
    collection, 
    addDoc, 
    doc, 
    setDoc, 
    getDoc,
    onSnapshot,
    serverTimestamp,
    query,
    where
} from 'firebase/firestore';
import { ArrowRight, Search, User, Clock, MessageSquare, CircleDashed, Phone, Users, Plus } from 'lucide-react';

// --- Configuração do Firebase ---
const firebaseConfig = typeof __firebase_config !== 'undefined' 
    ? JSON.parse(__firebase_config) 
    : { apiKey: "YOUR_API_KEY", authDomain: "YOUR_AUTH_DOMAIN", projectId: "YOUR_PROJECT_ID" };

const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-whatsapp-clone';

// --- Componentes da UI ---

// Tela de Login para definir o nome de usuário
const LoginScreen = ({ onLogin }) => {
    const [username, setUsername] = useState('');
    const [error, setError] = useState('');

    const handleLogin = (e) => {
        e.preventDefault();
        if (username.trim().length < 3) {
            setError('O nome de usuário deve ter pelo menos 3 caracteres.');
            return;
        }
        setError('');
        onLogin(username.trim());
    };

    return (
        <div className="flex h-screen w-full items-center justify-center bg-gray-100 dark:bg-gray-900">
            <div className="w-full max-w-sm p-8 bg-white dark:bg-gray-800 rounded-lg shadow-xl">
                <h1 className="text-2xl font-bold text-center text-gray-800 dark:text-gray-200 mb-2">Bem-vindo!</h1>
                <p className="text-center text-gray-500 dark:text-gray-400 mb-6">Crie seu nome de usuário para começar.</p>
                <form onSubmit={handleLogin}>
                    <input
                        type="text"
                        value={username}
                        onChange={(e) => setUsername(e.target.value)}
                        placeholder="Digite seu nome de usuário"
                        className="w-full bg-gray-100 dark:bg-gray-700 rounded-md py-3 px-4 focus:outline-none text-gray-800 dark:text-gray-200 mb-4"
                    />
                    {error && <p className="text-red-500 text-sm mb-4">{error}</p>}
                    <button type="submit" className="w-full bg-green-500 hover:bg-green-600 text-white rounded-md py-3 font-semibold transition-colors">
                        Entrar no Chat
                    </button>
                </form>
            </div>
        </div>
    );
};

// Bolha de Mensagem
const MessageBubble = ({ message, isSender }) => {
    const alignment = isSender ? 'justify-end' : 'justify-start';
    const colors = isSender ? 'bg-green-100 dark:bg-green-800' : 'bg-white dark:bg-gray-700';
    const timestamp = message.timestamp?.toDate().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) || '';

    return (
        <div className={`flex ${alignment} mb-2`}>
            <div className={`rounded-lg px-3 py-2 max-w-sm md:max-w-md lg:max-w-lg shadow ${colors}`}>
                <p className="text-sm text-gray-800 dark:text-gray-200">{message.text}</p>
                <p className={`text-xs text-right mt-1 ${isSender ? 'text-green-600 dark:text-green-400' : 'text-gray-400 dark:text-gray-500'}`}>
                    {timestamp}
                </p>
            </div>
        </div>
    );
};

// Janela de Chat
const ChatWindow = ({ chatPartner, currentUser, messages, onSendMessage }) => {
    const [newMessage, setNewMessage] = useState('');
    const messagesEndRef = useRef(null);

    useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
    }, [messages]);

    const handleSend = (e) => {
        e.preventDefault();
        if (newMessage.trim()) {
            onSendMessage(newMessage);
            setNewMessage('');
        }
    };
    
    if (!chatPartner) {
        return (
            <div className="flex-1 flex flex-col items-center justify-center bg-gray-100 dark:bg-gray-800 text-center p-4">
                 <div className="w-24 h-24 bg-gray-200 dark:bg-gray-700 rounded-full flex items-center justify-center mb-4">
                    <MessageSquare size={48} className="text-gray-400 dark:text-gray-500" />
                </div>
                <h2 className="text-xl font-medium text-gray-700 dark:text-gray-300">Selecione uma conversa</h2>
                <p className="text-gray-500 dark:text-gray-400 mt-2">Comece a conversar com os usuários disponíveis.</p>
            </div>
        );
    }

    const sortedMessages = [...messages].sort((a, b) => (a.timestamp?.toMillis() || 0) - (b.timestamp?.toMillis() || 0));

    return (
        <div className="flex-1 flex flex-col bg-gray-100 dark:bg-gray-900">
            <header className="bg-white dark:bg-gray-800 p-3 shadow-sm flex items-center z-10">
                <div className="w-10 h-10 bg-gray-300 dark:bg-gray-600 rounded-full flex items-center justify-center mr-3">
                    <User className="text-white dark:text-gray-300" />
                </div>
                <div>
                    <h2 className="font-semibold text-gray-800 dark:text-gray-200">{chatPartner.username || chatPartner.id.substring(0,12)}</h2>
                    <p className="text-xs text-gray-500 dark:text-gray-400">Online</p>
                </div>
            </header>
            <main className="flex-1 overflow-y-auto p-4 md:p-6">
                {sortedMessages.map(msg => <MessageBubble key={msg.id} message={msg} isSender={msg.senderId === currentUser.uid} />)}
                <div ref={messagesEndRef} />
            </main>
            <footer className="bg-white dark:bg-gray-800 p-3">
                <form onSubmit={handleSend} className="flex items-center">
                    <input type="text" value={newMessage} onChange={(e) => setNewMessage(e.target.value)} placeholder="Digite uma mensagem..." className="flex-1 bg-gray-100 dark:bg-gray-700 rounded-full py-2 px-4 focus:outline-none text-gray-800 dark:text-gray-200"/>
                    <button type="submit" className="bg-green-500 hover:bg-green-600 text-white rounded-full p-3 ml-3 transition-colors"><ArrowRight size={20} /></button>
                </form>
            </footer>
        </div>
    );
};

// Lista de Conversas
const ChatsList = ({ users, onSelectChat, selectedChatId }) => {
    const [searchTerm, setSearchTerm] = useState('');
    const filteredUsers = users.filter(user => user.username && user.username.toLowerCase().includes(searchTerm.toLowerCase()));

    return (
        <div className="h-full flex flex-col">
            <header className="p-3 border-b border-gray-200 dark:border-gray-700 flex-shrink-0">
                <div className="relative">
                    <Search size={18} className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" />
                    <input type="text" placeholder="Pesquisar conversas..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full bg-gray-100 dark:bg-gray-700 rounded-full py-2 pl-10 pr-4 focus:outline-none text-gray-800 dark:text-gray-200"/>
                </div>
            </header>
            <div className="flex-1 overflow-y-auto">
                {filteredUsers.length > 0 ? (
                    filteredUsers.map(user => (
                        <div key={user.id} onClick={() => onSelectChat(user)} className={`flex items-center p-3 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 ${selectedChatId === user.id ? 'bg-green-50 dark:bg-green-900/50' : ''}`}>
                            <div className="w-12 h-12 bg-gray-300 dark:bg-gray-600 rounded-full flex items-center justify-center mr-3"><User className="text-white dark:text-gray-300" /></div>
                            <div className="flex-1">
                                <h3 className="font-semibold text-gray-800 dark:text-gray-200">{user.username}</h3>
                                <p className="text-sm text-gray-500 dark:text-gray-400">Clique para conversar</p>
                            </div>
                        </div>
                    ))
                ) : (
                    <div className="p-4 text-center text-gray-500 dark:text-gray-400">
                        <p>Nenhum usuário encontrado.</p>
                        <p className="text-xs mt-2">Compartilhe o link para que outros entrem.</p>
                    </div>
                )}
            </div>
             <div className="p-4">
                <button className="w-14 h-14 bg-green-500 hover:bg-green-600 text-white rounded-full shadow-lg flex items-center justify-center ml-auto">
                    <Plus size={24} />
                </button>
            </div>
        </div>
    );
};

// Componente Placeholder para abas futuras
const PlaceholderTab = ({ title, icon: Icon }) => (
    <div className="flex-1 flex flex-col items-center justify-center bg-gray-100 dark:bg-gray-800 text-center p-4 h-full">
        <div className="w-24 h-24 bg-gray-200 dark:bg-gray-700 rounded-full flex items-center justify-center mb-4">
            <Icon size={48} className="text-gray-400 dark:text-gray-500" />
        </div>
        <h2 className="text-xl font-medium text-gray-700 dark:text-gray-300">{title}</h2>
        <p className="text-gray-500 dark:text-gray-400 mt-2">Esta funcionalidade estará disponível em breve.</p>
    </div>
);

// Layout Principal com Abas
const MainAppLayout = ({ user, db }) => {
    const [users, setUsers] = useState([]);
    const [selectedChat, setSelectedChat] = useState(null);
    const [messages, setMessages] = useState([]);
    const [activeTab, setActiveTab] = useState('chats');

    // Escuta de usuários
    useEffect(() => {
        if (!db || !user) return;
        const usersCollectionRef = collection(db, `artifacts/${appId}/public/data/users`);
        const q = query(usersCollectionRef, where("id", "!=", user.uid));
        const unsubscribe = onSnapshot(q, (snapshot) => {
            setUsers(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
        });
        return () => unsubscribe();
    }, [db, user]);

    // Escuta de mensagens
    useEffect(() => {
        if (!db || !user || !selectedChat) { setMessages([]); return; };
        const chatId = [user.uid, selectedChat.id].sort().join('_');
        const messagesRef = collection(db, `artifacts/${appId}/public/data/chats/${chatId}/messages`);
        const unsubscribe = onSnapshot(messagesRef, (snapshot) => {
            setMessages(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
        });
        return () => unsubscribe();
    }, [db, user, selectedChat]);

    const handleSendMessage = async (text) => {
        if (!db || !user || !selectedChat) return;
        const chatId = [user.uid, selectedChat.id].sort().join('_');
        const messagesRef = collection(db, `artifacts/${appId}/public/data/chats/${chatId}/messages`);
        await addDoc(messagesRef, { text, senderId: user.uid, receiverId: selectedChat.id, timestamp: serverTimestamp() });
    };

    const TabButton = ({ id, label, icon: Icon }) => (
        <button onClick={() => setActiveTab(id)} className={`flex-1 py-3 text-sm font-medium transition-colors ${activeTab === id ? 'text-green-500 border-b-2 border-green-500' : 'text-gray-500 dark:text-gray-400'}`}>
            <Icon className="mx-auto mb-1" />
            {label}
        </button>
    );

    const renderContent = () => {
        switch(activeTab) {
            case 'chats':
                return (
                    <div className="w-full h-full flex flex-col md:flex-row shadow-2xl">
                        <div className="w-full md:w-1/3 lg:w-1/4 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 flex flex-col">
                           <ChatsList users={users} onSelectChat={setSelectedChat} selectedChatId={selectedChat?.id} />
                        </div>
                        <div className="flex-1">
                           <ChatWindow chatPartner={selectedChat} currentUser={user} messages={messages} onSendMessage={handleSendMessage} />
                        </div>
                    </div>
                );
            case 'status':
                return <PlaceholderTab title="Status" icon={CircleDashed} />;
            case 'calls':
                return <PlaceholderTab title="Chamadas" icon={Phone} />;
            case 'groups':
                return <PlaceholderTab title="Grupos" icon={Users} />;
            default:
                return null;
        }
    }

    return (
        <div className="h-screen w-screen flex flex-col font-sans bg-gray-200 dark:bg-gray-900 text-sm">
            <header className="bg-white dark:bg-gray-800 shadow-md z-20">
                <div className="flex justify-between items-center p-3">
                    <h1 className="text-xl font-bold text-green-500">Chat App</h1>
                    <div className="text-xs text-gray-500 dark:text-gray-400">
                        Logado como: <span className="font-semibold">{user.username}</span>
                    </div>
                </div>
                <nav className="flex">
                    <TabButton id="chats" label="Conversas" icon={MessageSquare} />
                    <TabButton id="status" label="Status" icon={CircleDashed} />
                    <TabButton id="calls" label="Chamadas" icon={Phone} />
                    <TabButton id="groups" label="Grupos" icon={Users} />
                </nav>
            </header>
            <main className="flex-1 overflow-hidden">
                {renderContent()}
            </main>
        </div>
    );
};

// Componente Principal
export default function App() {
    const [auth, setAuth] = useState(null);
    const [db, setDb] = useState(null);
    const [user, setUser] = useState(null); // { uid, username }
    const [isLoading, setIsLoading] = useState(true);

    // Inicialização do Firebase
    useEffect(() => {
        const app = initializeApp(firebaseConfig);
        const authInstance = getAuth(app);
        const dbInstance = getFirestore(app);
        setAuth(authInstance);
        setDb(dbInstance);

        const unsubscribeAuth = onAuthStateChanged(authInstance, async (firebaseUser) => {
            if (firebaseUser) {
                const userRef = doc(dbInstance, `artifacts/${appId}/public/data/users`, firebaseUser.uid);
                const userSnap = await getDoc(userRef);
                if (userSnap.exists() && userSnap.data().username) {
                    setUser({ uid: firebaseUser.uid, ...userSnap.data() });
                } else {
                    setUser({ uid: firebaseUser.uid, username: null }); // Usuário autenticado, mas sem perfil
                }
            } else {
                setUser(null);
                // Tenta fazer login se não houver usuário
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(authInstance, __initial_auth_token);
                    } else {
                        await signInAnonymously(authInstance);
                    }
                } catch (error) {
                    console.error("Falha no login anônimo automático:", error);
                }
            }
            setIsLoading(false);
        });

        return () => unsubscribeAuth();
    }, []);

    const handleSetUsername = async (username) => {
        if (!db || !user || !user.uid) return;
        const userRef = doc(db, `artifacts/${appId}/public/data/users`, user.uid);
        try {
            await setDoc(userRef, { 
                id: user.uid, 
                username: username,
                lastSeen: serverTimestamp() 
            }, { merge: true });
            setUser(prev => ({ ...prev, username }));
        } catch (error) {
            console.error("Erro ao salvar nome de usuário:", error);
        }
    };

    if (isLoading) {
        return (
            <div className="flex h-screen w-full items-center justify-center bg-gray-100 dark:bg-gray-900">
                <div className="flex items-center space-x-2 text-gray-500">
                    <Clock className="animate-spin" />
                    <span>Carregando...</span>
                </div>
            </div>
        );
    }

    if (!user) {
         // Isso pode ser um estado de erro ou um redirecionamento
        return (
            <div className="flex h-screen w-full items-center justify-center bg-gray-100 dark:bg-gray-900">
                <div className="flex items-center space-x-2 text-red-500">
                    <span>Falha na autenticação. Por favor, recarregue a página.</span>
                </div>
            </div>
        );
    }
    
    if (!user.username) {
        return <LoginScreen onLogin={handleSetUsername} />;
    }

    return <MainAppLayout user={user} db={db} />;
}
