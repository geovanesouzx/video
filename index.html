<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatApp - Semelhante ao Telegram</title>
    
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://css.gg/css?=|add" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #e5e7eb; }
        ::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f7;
        }
        .message-bubble-sent { background-color: #e2ffc7; }
        .message-bubble-received { background-color: #ffffff; }
        #username-modal.hidden { display: none; }
        #chat-placeholder.hidden { display: none; }
        .contact-list-item.active { background-color: #3b82f6; color: white; }
        .contact-list-item.active:hover { background-color: #2563eb; }
    </style>
</head>
<body class="antialiased">

    <!-- Username Selection Modal -->
    <div id="username-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Escolha seu nome de usuário</h2>
            <p class="text-gray-600 mb-6">Este será seu nome único no chat.</p>
            <form id="username-form">
                <input type="text" id="username-input" placeholder="Ex: joaosilva" class="w-full border border-gray-300 rounded-lg py-3 px-4 mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                <p id="username-error" class="text-red-500 text-sm mb-4 hidden"></p>
                <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition duration-200">
                    Entrar no Chat
                </button>
            </form>
        </div>
    </div>

    <div class="flex h-screen bg-white md:bg-transparent">
        <!-- Sidebar / Contact List -->
        <div class="w-full md:w-1/3 lg:w-1/4 bg-white p-0 flex flex-col border-r border-gray-200">
            <div class="p-4 border-b border-gray-200">
                 <div class="flex items-center justify-between">
                    <p id="current-username-display" class="font-semibold text-gray-800 text-lg">Carregando...</p>
                    <button class="text-gray-500"><i class="fas fa-bars text-xl"></i></button>
                </div>
                 <div class="mt-4 relative">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    <input type="search" id="user-search-input" placeholder="Pesquisar ou adicionar usuários" class="w-full bg-gray-100 rounded-full py-2 pl-10 pr-4 text-sm focus:outline-none">
                </div>
            </div>
            <div id="contact-list-container" class="flex-1 overflow-y-auto">
                <!-- Contact list or search results will be dynamically inserted here -->
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="w-full md:w-2/3 lg:w-3/4 flex flex-col bg-gray-100" style="background-image: url('https://i.pinimg.com/736x/8c/98/99/8c98994518b575bfd8c949e91d20548b.jpg'); background-size: contain;">
            
            <div id="chat-placeholder" class="flex-1 flex flex-col items-center justify-center text-center p-4">
                <i class="fas fa-comments text-6xl text-gray-400 mb-4"></i>
                <h2 class="text-2xl font-semibold text-gray-600">Selecione uma conversa</h2>
                <p class="text-gray-500">Escolha um contato na lista à esquerda para começar a conversar.</p>
            </div>

            <div id="chat-view" class="hidden flex-1 flex-col">
                <div class="bg-white p-3 border-b border-gray-200 flex items-center justify-between shadow-sm">
                    <div>
                        <h2 id="chat-header-name" class="text-lg font-semibold text-gray-800"></h2>
                        <p class="text-xs text-gray-500">online</p>
                    </div>
                </div>
                <div id="messages-container" class="flex-1 p-4 overflow-y-auto"></div>
                <div class="p-4 bg-white border-t border-gray-200 shadow-inner">
                    <form id="message-form" class="flex items-center space-x-4">
                        <input type="text" id="message-input" placeholder="Mensagem" autocomplete="off" class="flex-1 bg-gray-100 border-transparent rounded-full py-3 px-5 text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" disabled>
                        <button type="submit" id="send-button" class="bg-blue-500 hover:bg-blue-600 text-white rounded-full w-12 h-12 flex items-center justify-center transition duration-200 transform hover:scale-110" disabled>
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, setLogLevel, doc, getDoc, setDoc, where, getDocs, collectionGroup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Config ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyB98-bStjweF82UALPiw2YiwKKn1IhZASE",
            authDomain: "videochamada11.firebaseapp.com",
            projectId: "videochamada11",
            storageBucket: "videochamada11.firebasestorage.app",
            messagingSenderId: "872635256324",
            appId: "1:872635256324:web:12a6051efe8796730f2f51"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-chat-app';

        // --- Initialize Firebase ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        setLogLevel('debug');

        // --- DOM Elements ---
        const usernameModal = document.getElementById('username-modal'),
              usernameForm = document.getElementById('username-form'),
              usernameInput = document.getElementById('username-input'),
              usernameError = document.getElementById('username-error'),
              currentUserDisplay = document.getElementById('current-username-display'),
              userSearchInput = document.getElementById('user-search-input'),
              contactListContainer = document.getElementById('contact-list-container'),
              chatPlaceholder = document.getElementById('chat-placeholder'),
              chatView = document.getElementById('chat-view'),
              chatHeaderName = document.getElementById('chat-header-name'),
              messagesContainer = document.getElementById('messages-container'),
              messageForm = document.getElementById('message-form'),
              messageInput = document.getElementById('message-input'),
              sendButton = document.getElementById('send-button');

        // --- App State ---
        let currentUser = null,
            contacts = new Map(), // Map UID to contact data {username, uid}
            selectedChat = null,
            messagesUnsubscribe = null,
            contactsUnsubscribe = null;

        // --- Authentication & User Setup ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = { uid: user.uid };
                await checkUserSetup();
            } else {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                    else await signInAnonymously(auth);
                } catch (error) { console.error("Authentication Error:", error); }
            }
        });

        async function checkUserSetup() {
            const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, currentUser.uid);
            const userDoc = await getDoc(userDocRef);
            if (userDoc.exists()) {
                currentUser.username = userDoc.data().username;
                usernameModal.classList.add('hidden');
                initializeAppUI();
            } else {
                usernameModal.classList.remove('hidden');
            }
        }

        usernameForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = usernameInput.value.trim().toLowerCase();
            if (username.length < 3) {
                usernameError.textContent = 'O nome de usuário deve ter pelo menos 3 caracteres.';
                usernameError.classList.remove('hidden');
                return;
            }
            const usersRef = collection(db, `artifacts/${appId}/public/data/users`);
            const q = query(usersRef, where("username", "==", username));
            const querySnapshot = await getDocs(q);
            if (!querySnapshot.empty) {
                usernameError.textContent = 'Este nome de usuário já está em uso.';
                usernameError.classList.remove('hidden');
            } else {
                const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, currentUser.uid);
                await setDoc(userDocRef, { username: username, uid: currentUser.uid });
                currentUser.username = username;
                usernameModal.classList.add('hidden');
                initializeAppUI();
            }
        });

        function initializeAppUI() {
            currentUserDisplay.textContent = currentUser.username;
            loadContacts();
            userSearchInput.addEventListener('input', handleSearch);
        }

        // --- Contact & Search Management ---
        function loadContacts() {
            if (contactsUnsubscribe) contactsUnsubscribe();
            const contactsRef = collection(db, `artifacts/${appId}/public/data/users/${currentUser.uid}/contacts`);
            contactsUnsubscribe = onSnapshot(contactsRef, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const contactData = change.doc.data();
                    if (change.type === "added" || change.type === "modified") {
                        contacts.set(contactData.uid, contactData);
                    }
                    if (change.type === "removed") {
                        contacts.delete(contactData.uid);
                    }
                });
                if (userSearchInput.value.trim() === '') {
                    renderContactList(Array.from(contacts.values()));
                }
            });
        }

        async function handleSearch(e) {
            const searchTerm = e.target.value.trim().toLowerCase();
            if (searchTerm === '') {
                renderContactList(Array.from(contacts.values()));
                return;
            }
            const usersRef = collection(db, `artifacts/${appId}/public/data/users`);
            const q = query(usersRef, where('username', '>=', searchTerm), where('username', '<=', searchTerm + '\uf8ff'));
            const snapshot = await getDocs(q);
            const searchResults = [];
            snapshot.forEach(doc => {
                const user = doc.data();
                if (user.uid !== currentUser.uid) {
                    searchResults.push(user);
                }
            });
            renderSearchResults(searchResults);
        }

        async function addContact(userToAdd) {
            const contactRef = doc(db, `artifacts/${appId}/public/data/users/${currentUser.uid}/contacts`, userToAdd.uid);
            await setDoc(contactRef, userToAdd);
            userSearchInput.value = '';
            renderContactList(Array.from(contacts.values()));
        }

        function renderContactList(contactArray) {
            contactListContainer.innerHTML = '';
            if (contactArray.length === 0) {
                contactListContainer.innerHTML = `<p class="text-center text-gray-500 p-4 text-sm">Pesquise para adicionar contatos.</p>`;
                return;
            }
            contactArray.forEach(contact => {
                const contactElement = createContactElement(contact);
                contactElement.addEventListener('click', () => selectChatWithUser(contact));
                contactListContainer.appendChild(contactElement);
            });
        }

        function renderSearchResults(results) {
            contactListContainer.innerHTML = '';
             if (results.length === 0) {
                contactListContainer.innerHTML = `<p class="text-center text-gray-500 p-4 text-sm">Nenhum usuário encontrado.</p>`;
                return;
            }
            results.forEach(user => {
                const isContact = contacts.has(user.uid);
                const resultElement = createContactElement(user, !isContact);
                if (!isContact) {
                    resultElement.querySelector('.add-contact-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        addContact(user);
                    });
                }
                resultElement.addEventListener('click', () => selectChatWithUser(user));
                contactListContainer.appendChild(resultElement);
            });
        }

        function createContactElement(user, showAddButton = false) {
            const element = document.createElement('div');
            element.classList.add('contact-list-item', 'flex', 'items-center', 'p-3', 'border-b', 'border-gray-200', 'hover:bg-gray-100', 'cursor-pointer');
            if (selectedChat && selectedChat.uid === user.uid) {
                element.classList.add('active');
            }
            element.innerHTML = `
                <img src="https://placehold.co/50x50/7c3aed/white?text=${user.username.charAt(0).toUpperCase()}" alt="Avatar" class="w-10 h-10 rounded-full mr-3">
                <div class="flex-1 text-gray-800">
                    <h3 class="font-semibold text-sm">${user.username}</h3>
                </div>
                ${showAddButton ? '<button class="add-contact-btn bg-blue-500 text-white text-xs rounded-full h-7 w-7 flex items-center justify-center hover:bg-blue-600"><i class="fas fa-plus"></i></button>' : ''}
            `;
            return element;
        }

        function selectChatWithUser(user) {
            chatPlaceholder.classList.add('hidden');
            chatView.classList.remove('hidden');
            chatView.classList.add('flex');
            messageInput.disabled = false;
            sendButton.disabled = false;

            const chatRoomId = [currentUser.uid, user.uid].sort().join('_');
            selectedChat = { ...user, chatRoomId };
            
            chatHeaderName.textContent = selectedChat.username;
            if (userSearchInput.value.trim() === '') {
                renderContactList(Array.from(contacts.values()));
            }
            loadMessages(selectedChat.chatRoomId);
        }

        // --- Message Handling ---
        function loadMessages(chatRoomId) {
            if (messagesUnsubscribe) messagesUnsubscribe();
            const messagesRef = collection(db, `artifacts/${appId}/public/data/chats/${chatRoomId}/messages`);
            const q = query(messagesRef);
            messagesUnsubscribe = onSnapshot(q, (snapshot) => {
                const messages = [];
                snapshot.forEach(doc => messages.push(doc.data()));
                messages.sort((a, b) => (a.createdAt?.toMillis() || 0) - (b.createdAt?.toMillis() || 0));
                messagesContainer.innerHTML = '';
                messages.forEach(displayMessage);
                scrollToBottom();
            });
        }
        
        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const messageText = messageInput.value.trim();
            if (messageText && selectedChat) {
                const messagesRef = collection(db, `artifacts/${appId}/public/data/chats/${selectedChat.chatRoomId}/messages`);
                await addDoc(messagesRef, {
                    text: messageText,
                    senderId: currentUser.uid,
                    createdAt: serverTimestamp()
                });
                messageInput.value = '';
                scrollToBottom();
            }
        });

        function displayMessage(message) {
            const isCurrentUser = message.senderId === currentUser.uid;
            const time = message.createdAt ? message.createdAt.toDate().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : '';
            const messageElement = document.createElement('div');
            const bubbleClasses = 'p-3 rounded-lg max-w-md md:max-w-lg relative shadow';
            const bubbleContent = `
                <p class="text-sm text-gray-800">${message.text}</p>
                <div class="text-right text-xs text-gray-500 mt-1">${time}</div>
            `;
            if (isCurrentUser) {
                messageElement.classList.add('flex', 'justify-end', 'mb-3');
                messageElement.innerHTML = `<div class="${bubbleClasses} message-bubble-sent">${bubbleContent}</div>`;
            } else {
                messageElement.classList.add('flex', 'justify-start', 'mb-3');
                messageElement.innerHTML = `<div class="${bubbleClasses} message-bubble-received">${bubbleContent}</div>`;
            }
            messagesContainer.appendChild(messageElement);
        }

        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
    </script>
</body>
</html>
