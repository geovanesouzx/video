<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord Clone - Compartilhamento de Áudio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }
        .video-container {
            position: relative;
            background-color: #202225;
            border-radius: 0.5rem;
            overflow: hidden;
            aspect-ratio: 16 / 9;
        }
        .video-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .video-container .user-label {
            position: absolute;
            bottom: 8px;
            left: 8px;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
        }
    </style>
</head>
<body class="bg-[#36393f] text-gray-300 flex h-screen">

    <!-- Sidebar de Canais -->
    <div class="w-60 bg-[#2f3136] flex flex-col">
        <div class="p-4 font-bold text-white border-b border-gray-900/50">
            Servidor Principal
        </div>
        <div class="flex-1 p-2 space-y-2 overflow-y-auto scrollbar-hide">
            <div>
                <h2 class="px-2 text-xs font-bold tracking-wider text-gray-400 uppercase">Canais de Voz</h2>
                <div id="voice-channel" class="flex items-center p-2 mt-1 rounded cursor-pointer hover:bg-gray-700/50">
                    <i class="fas fa-volume-up w-5 mr-2 text-gray-400"></i>
                    <span>Sala de Voz</span>
                </div>
            </div>
        </div>
        <div id="user-info-panel" class="p-2 bg-[#292b2f] flex items-center justify-between">
            <div class="flex items-center">
                <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center mr-2">
                    <i class="fas fa-user text-white"></i>
                </div>
                <div class="text-sm">
                    <div class="font-semibold text-white truncate" id="user-id-display">Carregando...</div>
                    <div id="connection-status" class="text-xs text-red-500">Desconectado</div>
                </div>
            </div>
             <button id="copy-id-button" title="Copiar ID de Usuário" class="px-2 py-1 text-xs text-gray-400 bg-gray-700 rounded hover:bg-gray-600">
                <i class="fas fa-copy"></i>
            </button>
        </div>
    </div>

    <!-- Conteúdo Principal -->
    <div class="flex-1 flex flex-col bg-[#36393f]">
        <div class="p-4 border-b shadow-md border-gray-900/50 text-white font-semibold">
            <i class="fas fa-hashtag mr-2 text-gray-500"></i>
            Bem-vindo!
        </div>
        <div id="main-content" class="flex-1 p-4 overflow-y-auto">
            <div id="videos-grid" class="video-grid">
                <!-- Vídeos dos participantes serão adicionados aqui -->
            </div>
            <div id="placeholder-content" class="flex flex-col items-center justify-center h-full text-center text-gray-500">
                <i class="fas fa-headset fa-4x mb-4"></i>
                <h2 class="text-2xl font-semibold">Você não está em um canal de voz.</h2>
                <p>Clique em "Sala de Voz" à esquerda para entrar e conversar.</p>
            </div>
        </div>
        <div id="call-controls" class="p-2 bg-[#2f3136] border-t border-gray-900/50 flex items-center justify-center space-x-4 hidden">
            <button id="toggle-mic-button" class="w-12 h-12 bg-gray-600 rounded-full flex items-center justify-center text-white hover:bg-gray-500 transition-colors" title="Mutar Microfone">
                <i class="fas fa-microphone"></i>
            </button>
            <button id="share-audio-button" class="w-12 h-12 bg-gray-600 rounded-full flex items-center justify-center text-white hover:bg-gray-500 transition-colors" title="Compartilhar Áudio/Tela">
                <i class="fas fa-desktop"></i>
            </button>
            <button id="leave-call-button" class="w-16 h-12 bg-red-600 rounded-full flex items-center justify-center text-white hover:bg-red-500 transition-colors" title="Sair da Chamada">
                <i class="fas fa-phone-slash"></i>
            </button>
        </div>
    </div>
    
    <!-- Modal de Notificação -->
    <div id="notification-modal" class="hidden fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg transition-opacity duration-300 z-50">
        ID copiado para a área de transferência!
    </div>
    
    <!-- Modal de Erro -->
    <div id="error-modal" class="hidden fixed top-5 left-1/2 -translate-x-1/2 bg-red-600 text-white py-3 px-6 rounded-lg shadow-lg transition-opacity duration-300 z-50">
        <span id="error-message"></span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, deleteDoc, getDocs, writeBatch, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuração do Firebase ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "YOUR_API_KEY", authDomain: "...", projectId: "..." };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-discord-clone';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        setLogLevel('debug'); // Habilita logs detalhados para depuração

        // --- Variáveis Globais ---
        let userId;
        let localStream;
        let screenStream;
        let originalAudioTrack;
        let isMuted = false;
        let isSharingAudio = false;
        const peerConnections = {};
        const voiceChannelId = 'general';

        const servers = {
            iceServers: [
                { urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] },
            ],
            iceCandidatePoolSize: 10,
        };

        // --- Elementos da UI ---
        const ui = {
            voiceChannel: document.getElementById('voice-channel'),
            videosGrid: document.getElementById('videos-grid'),
            placeholderContent: document.getElementById('placeholder-content'),
            callControls: document.getElementById('call-controls'),
            connectionStatus: document.getElementById('connection-status'),
            userIdDisplay: document.getElementById('user-id-display'),
            copyIdButton: document.getElementById('copy-id-button'),
            notificationModal: document.getElementById('notification-modal'),
            errorModal: document.getElementById('error-modal'),
            errorMessage: document.getElementById('error-message'),
            toggleMicButton: document.getElementById('toggle-mic-button'),
            shareAudioButton: document.getElementById('share-audio-button'),
            leaveCallButton: document.getElementById('leave-call-button'),
        };

        // --- Funções Principais ---

        async function main() {
            try {
                // Autentica o usuário. Usa o token customizado se disponível, senão, anonimamente.
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication failed:", error);
                showError("Falha na autenticação.");
            }
            
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    ui.userIdDisplay.textContent = `${userId}`; // Mostra o ID completo
                    ui.copyIdButton.onclick = () => copyToClipboard(userId);
                    
                    await cleanUpFirestoreData(userId);
                } else {
                    console.log("Usuário desconectado.");
                    ui.userIdDisplay.textContent = 'Desconectado';
                }
            });
        }

        async function joinVoiceChannel() {
            if (!userId) {
                showError("Você precisa estar autenticado para entrar.");
                console.error("Usuário não autenticado.");
                return;
            }

            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                originalAudioTrack = localStream.getAudioTracks()[0];
                addVideoStream(userId, localStream, true);

                ui.placeholderContent.classList.add('hidden');
                ui.callControls.classList.remove('hidden');
                ui.connectionStatus.textContent = 'Conectado';
                ui.connectionStatus.className = 'text-xs text-green-500';

                // CORREÇÃO: Usa o caminho público do Firestore
                const basePath = `artifacts/${appId}/public/data/channels/${voiceChannelId}`;
                const membersCol = collection(db, `${basePath}/members`);
                const signalsCol = collection(db, `${basePath}/signals/${userId}`);

                await setDoc(doc(membersCol, userId), { id: userId, joinedAt: new Date() });

                onSnapshot(membersCol, (snapshot) => {
                    snapshot.docChanges().forEach(async (change) => {
                        const remoteUserId = change.doc.id;
                        if (remoteUserId === userId) return;

                        if (change.type === 'added') {
                            console.log(`Novo membro detectado: ${remoteUserId}. Criando conexão.`);
                            createPeerConnection(remoteUserId, true);
                        }
                        if (change.type === 'removed') {
                            console.log(`Membro ${remoteUserId} saiu. Fechando conexão.`);
                            closePeerConnection(remoteUserId);
                        }
                    });
                });

                onSnapshot(signalsCol, (snapshot) => {
                    snapshot.docChanges().forEach(async (change) => {
                        if (change.type === 'added') {
                            const data = change.doc.data();
                            const remoteUserId = data.from;
                            
                            if (!peerConnections[remoteUserId] && (data.offer || data.iceCandidate)) {
                                 createPeerConnection(remoteUserId, false);
                            }
                            
                            const pc = peerConnections[remoteUserId];
                            if(!pc) return;

                            if (data.offer) {
                                console.log(`Recebendo oferta de ${remoteUserId}`);
                                await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
                                const answer = await pc.createAnswer();
                                await pc.setLocalDescription(answer);
                                await sendSignal(remoteUserId, { answer: pc.localDescription.toJSON() });
                            } else if (data.answer) {
                                console.log(`Recebendo resposta de ${remoteUserId}`);
                                if (pc.signalingState !== 'stable') {
                                    await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
                                }
                            } else if (data.iceCandidate) {
                                try {
                                    await pc.addIceCandidate(new RTCIceCandidate(data.iceCandidate));
                                } catch (e) {
                                    console.error('Erro ao adicionar ICE candidate:', e);
                                }
                            }
                            await deleteDoc(change.doc.ref);
                        }
                    });
                });

            } catch (error) {
                console.error("Erro ao entrar no canal de voz:", error);
                showError("Câmera/microfone não acessível. Verifique as permissões.");
            }
        }
        
        function createPeerConnection(remoteUserId, isInitiator) {
            if (peerConnections[remoteUserId]) return;

            console.log(`Criando PeerConnection para ${remoteUserId}. Iniciador: ${isInitiator}`);
            const pc = new RTCPeerConnection(servers);
            peerConnections[remoteUserId] = pc;

            localStream.getTracks().forEach(track => {
                pc.addTrack(track, localStream);
            });

            pc.onicecandidate = event => {
                if (event.candidate) {
                    sendSignal(remoteUserId, { iceCandidate: event.candidate.toJSON() });
                }
            };

            pc.ontrack = event => {
                console.log(`Track recebida de ${remoteUserId}`);
                const remoteStream = event.streams[0];
                addVideoStream(remoteUserId, remoteStream);
            };

            pc.oniceconnectionstatechange = () => {
                if (pc.iceConnectionState === 'failed' || pc.iceConnectionState === 'disconnected' || pc.iceConnectionState === 'closed') {
                     console.log(`Conexão com ${remoteUserId} falhou/fechou.`);
                     closePeerConnection(remoteUserId);
                }
            };

            if (isInitiator) {
                pc.createOffer()
                    .then(offer => pc.setLocalDescription(offer))
                    .then(() => {
                        sendSignal(remoteUserId, { offer: pc.localDescription.toJSON() });
                    })
                    .catch(e => console.error("Erro ao criar oferta:", e));
            }
        }

        async function sendSignal(toUserId, data) {
            const signalData = { ...data, from: userId, timestamp: new Date() };
            // CORREÇÃO: Usa o caminho público do Firestore
            const signalDocRef = doc(collection(db, `artifacts/${appId}/public/data/channels/${voiceChannelId}/signals/${toUserId}`));
            await setDoc(signalDocRef, signalData);
        }
        
        async function leaveVoiceChannel() {
            Object.keys(peerConnections).forEach(remoteUserId => {
                closePeerConnection(remoteUserId);
            });

            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            if (screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
                screenStream = null;
            }

            ui.videosGrid.innerHTML = '';
            ui.placeholderContent.classList.remove('hidden');
            ui.callControls.classList.add('hidden');
            ui.connectionStatus.textContent = 'Desconectado';
            ui.connectionStatus.className = 'text-xs text-red-500';
            isSharingAudio = false;
            updateShareButton();

            if (userId) {
                // CORREÇÃO: Usa o caminho público do Firestore
                const memberDoc = doc(db, `artifacts/${appId}/public/data/channels/${voiceChannelId}/members`, userId);
                await deleteDoc(memberDoc);
            }
             console.log("Saiu do canal de voz.");
        }

        function closePeerConnection(remoteUserId) {
            if (peerConnections[remoteUserId]) {
                peerConnections[remoteUserId].close();
                delete peerConnections[remoteUserId];
            }
            const videoElement = document.getElementById(`video-${remoteUserId}`);
            if (videoElement) {
                videoElement.remove();
            }
        }

        async function toggleMicrophone() {
            if (!localStream) return;
            isMuted = !isMuted;
            localStream.getAudioTracks().forEach(track => track.enabled = !isMuted);
            
            const icon = ui.toggleMicButton.querySelector('i');
            icon.className = isMuted ? 'fas fa-microphone-slash' : 'fas fa-microphone';
            ui.toggleMicButton.classList.toggle('bg-red-600', isMuted);
            ui.toggleMicButton.classList.toggle('bg-gray-600', !isMuted);
        }

        async function shareAudio() {
            if (isSharingAudio) {
                stopSharing();
                return;
            }

            try {
                screenStream = await navigator.mediaDevices.getDisplayMedia({
                    video: true,
                    audio: { echoCancellation: true, noiseSuppression: true, sampleRate: 44100 }
                });

                const screenAudioTrack = screenStream.getAudioTracks()[0];
                if (screenAudioTrack) {
                    isSharingAudio = true;
                    for (const peerId in peerConnections) {
                        const pc = peerConnections[peerId];
                        const sender = pc.getSenders().find(s => s.track && s.track.kind === 'audio');
                        if (sender) {
                            sender.replaceTrack(screenAudioTrack);
                        }
                    }
                    screenStream.getTracks().forEach(track => track.onended = () => stopSharing());
                } else {
                     showError("Áudio da aba/sistema não foi compartilhado. Tente novamente.");
                     screenStream.getTracks().forEach(track => track.stop());
                     screenStream = null;
                }
                updateShareButton();
            } catch (err) {
                console.error("Erro ao compartilhar tela/áudio:", err);
            }
        }

        function stopSharing() {
            if (!isSharingAudio) return;
            isSharingAudio = false;

             for (const peerId in peerConnections) {
                const pc = peerConnections[peerId];
                const sender = pc.getSenders().find(s => s.track && s.track.kind === 'audio');
                if (sender && originalAudioTrack) {
                    sender.replaceTrack(originalAudioTrack);
                }
            }

            if (screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
                screenStream = null;
            }
            updateShareButton();
        }

        // --- Funções Auxiliares ---

        function addVideoStream(id, stream, isLocal = false) {
            if (document.getElementById(`video-${id}`)) return;

            const container = document.createElement('div');
            container.id = `video-${id}`;
            container.className = 'video-container';

            const video = document.createElement('video');
            video.srcObject = stream;
            video.autoplay = true;
            video.playsInline = true;
            video.muted = isLocal;
            if (isLocal) {
                 video.style.transform = "scaleX(-1)";
            }

            const label = document.createElement('div');
            label.className = 'user-label';
            label.textContent = isLocal ? 'Você' : `User ${id.substring(0, 4)}`;

            container.appendChild(video);
            container.appendChild(label);
            ui.videosGrid.appendChild(container);
        }

        function updateShareButton() {
            const icon = ui.shareAudioButton.querySelector('i');
            if (isSharingAudio) {
                ui.shareAudioButton.classList.add('bg-green-600');
                ui.shareAudioButton.classList.remove('bg-gray-600');
                icon.className = 'fas fa-stop-circle';
                ui.shareAudioButton.title = "Parar Compartilhamento";
            } else {
                ui.shareAudioButton.classList.remove('bg-green-600');
                ui.shareAudioButton.classList.add('bg-gray-600');
                icon.className = 'fas fa-desktop';
                ui.shareAudioButton.title = "Compartilhar Áudio/Tela";
            }
        }
        
        function copyToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                showNotification("ID copiado para a área de transferência!");
            } catch (err) {
                console.error('Falha ao copiar texto: ', err);
                showError("Falha ao copiar o ID.");
            }
            document.body.removeChild(textArea);
        }

        function showNotification(message) {
            ui.notificationModal.textContent = message;
            ui.notificationModal.classList.remove('hidden');
            ui.notificationModal.classList.add('opacity-100');
            setTimeout(() => {
                ui.notificationModal.classList.remove('opacity-100');
                setTimeout(() => ui.notificationModal.classList.add('hidden'), 150);
            }, 2000);
        }
        
        function showError(message) {
            ui.errorMessage.textContent = message;
            ui.errorModal.classList.remove('hidden');
            ui.errorModal.classList.add('opacity-100');
            setTimeout(() => {
                ui.errorModal.classList.remove('opacity-100');
                setTimeout(() => ui.errorModal.classList.add('hidden'), 150);
            }, 4000);
        }
        
        async function cleanUpFirestoreData(currentUserId) {
            // CORREÇÃO: Usa o caminho público do Firestore
            const basePath = `artifacts/${appId}/public/data/channels/${voiceChannelId}`;
            await deleteDoc(doc(db, `${basePath}/members`, currentUserId));
            
            const signalsQuery = collection(db, `${basePath}/signals/${currentUserId}`);
            const signalsSnapshot = await getDocs(signalsQuery);
            const batch = writeBatch(db);
            signalsSnapshot.docs.forEach(doc => batch.delete(doc.ref));
            await batch.commit();
            console.log("Dados antigos do Firestore limpos.");
        }
        
        // --- Listeners de Eventos da UI ---
        ui.voiceChannel.addEventListener('click', joinVoiceChannel);
        ui.leaveCallButton.addEventListener('click', leaveVoiceChannel);
        ui.toggleMicButton.addEventListener('click', toggleMicrophone);
        ui.shareAudioButton.addEventListener('click', shareAudio);
        
        window.addEventListener('beforeunload', leaveVoiceChannel);

        // --- Inicialização ---
        main();

    </script>
</body>
</html>
